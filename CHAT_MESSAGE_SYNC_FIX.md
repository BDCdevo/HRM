# ุฅุตูุงุญ ูุดููุฉ ูุฒุงููุฉ ุงูุฑุณุงุฆู ูู ุงูุดุงุช

## ๐ ุงููุดููุฉ

ุนูุฏ ุฅุฑุณุงู ุฑุณุงูุฉ ูู ุงูุดุงุช:
- **ุงููุฑุณู**: ูุฑู ุฑุณุงุฆูู ููุท
- **ุงููุณุชูุจู**: ูุฑู ุฑุณุงุฆูู ููุท
- **ุงูุณุจุจ**: ุนุฏู ุชุญุฏูุซ ูุงุฆูุฉ ุงูุฑุณุงุฆู ุจุนุฏ ุงูุฅุฑุณุงู ููุญุตูู ุนูู ุฌููุน ุงูุฑุณุงุฆู ูู ุงูุณูุฑูุฑ

## ๐ ุงูุชุญููู

### ุงููุดุงูู ุงูููุชุดูุฉ:

1. **ูู `MessagesCubit`**:
   - ุจุนุฏ ุฅุฑุณุงู ุงูุฑุณุงูุฉุ ูุชู ุฅุถุงูุชูุง ูููุงุฆูุฉ ุงููุญููุฉ ููุท
   - ูุง ูุชู ุนูู refresh ูุฌูุจ ุฌููุน ุงูุฑุณุงุฆู ูู ุงูุณูุฑูุฑ
   - ุงููุชูุฌุฉ: ูู ูุณุชุฎุฏู ูุฑู ุฑุณุงุฆูู ููุท

2. **ูู Backend (ChatController.php)**:
   - ุงูู `broadcast()->toOthers()` ูุฑุณู ุงูุฑุณุงูุฉ ูููุณุชุฎุฏููู ุงูุขุฎุฑูู ููุท
   - ุงููุฑุณู ูุง ูุชููู ูุณุฎุฉ ุนุจุฑ WebSocket
   - ุงูุญู: ุงูุงุนุชูุงุฏ ุนูู ุงูู API refresh ุจุฏูุงู ูู WebSocket ููุท

3. **ูู Polling**:
   - ูุนูู ูู 3 ุซูุงูู ููู ูุฏ ูููู ููุงู ุชุฃุฎูุฑ
   - ุงูุญู ุงูุฃูุถู: refresh ููุฑู ุจุนุฏ ุงูุฅุฑุณุงู

## โ ุงูุญู ุงููุทุจู

### ุงูุชุนุฏููุงุช ุนูู `MessagesCubit`

**ุงูููู**: `lib/features/chat/logic/cubit/messages_cubit.dart`

```dart
Future<void> sendMessage({
  required int conversationId,
  required int companyId,
  String? message,
  File? attachment,
}) async {
  try {
    // Show sending state with current messages
    emit(MessageSending(_currentMessages));

    final sentMessage = await _repository.sendMessage(
      conversationId: conversationId,
      companyId: companyId,
      message: message,
      attachment: attachment,
    );

    // Add new message to the list
    final updatedMessages = [..._currentMessages, sentMessage];
    _currentMessages = updatedMessages;

    emit(MessageSent(updatedMessages));

    // โ ุฅุถุงูุฉ ุฌุฏูุฏุฉ: Refresh ููุฑู ูุฌูุจ ุฌููุน ุงูุฑุณุงุฆู
    await refreshMessages(
      conversationId: conversationId,
      companyId: companyId,
    );
  } catch (e) {
    print('โ MessagesCubit - Send Message Error: $e');
    emit(MessageSendError(e.toString(), _currentMessages));
  }
}
```

### ููู ูุนูู ุงูุญู:

1. **ุฅุฑุณุงู ุงูุฑุณุงูุฉ**: ูุชู ุฅุฑุณุงู ุงูุฑุณุงูุฉ ููุณูุฑูุฑ
2. **ุชุญุฏูุซ ูุญูู**: ุฅุถุงูุฉ ุงูุฑุณุงูุฉ ูููุงุฆูุฉ ุงููุญููุฉ ููุฑุงู (Optimistic Update)
3. **Refresh ููุฑู**: ุฌูุจ ุฌููุน ุงูุฑุณุงุฆู ูู ุงูุณูุฑูุฑ (ูุดูู ุฑุณุงุฆู ุฌููุน ุงููุณุชุฎุฏููู)
4. **Polling**: ูุณุชูุฑ ูู ุงูุนูู ูู 3 ุซูุงูู ูู fallback

## ๐ ูุชูุฌุฉ ุงูุฅุตูุงุญ

### ูุจู ุงูุฅุตูุงุญ:
```
ุงููุณุชุฎุฏู A ูุฑุณู: "ูุฑุญุจุงู"
  โ
ุงููุณุชุฎุฏู A ูุฑู: ["ูุฑุญุจุงู"]
ุงููุณุชุฎุฏู B ูุฑู: []  โ

ุงููุณุชุฎุฏู B ูุฑุณู: "ุฃููุงู"
  โ
ุงููุณุชุฎุฏู A ูุฑู: ["ูุฑุญุจุงู"]  โ
ุงููุณุชุฎุฏู B ูุฑู: ["ุฃููุงู"]  โ
```

### ุจุนุฏ ุงูุฅุตูุงุญ:
```
ุงููุณุชุฎุฏู A ูุฑุณู: "ูุฑุญุจุงู"
  โ (Refresh ููุฑู)
ุงููุณุชุฎุฏู A ูุฑู: ["ูุฑุญุจุงู"] โ
ุงููุณุชุฎุฏู B ูุฑู: ["ูุฑุญุจุงู"] โ (ุนุจุฑ Polling)

ุงููุณุชุฎุฏู B ูุฑุณู: "ุฃููุงู"
  โ (Refresh ููุฑู)
ุงููุณุชุฎุฏู A ูุฑู: ["ูุฑุญุจุงู", "ุฃููุงู"] โ (ุนุจุฑ Polling)
ุงููุณุชุฎุฏู B ูุฑู: ["ูุฑุญุจุงู", "ุฃููุงู"] โ
```

## ๐งช ููููุฉ ุงูุงุฎุชุจุงุฑ

### ุงุฎุชุจุงุฑ ูุฏูู:

1. **ุชุณุฌูู ุฏุฎูู ุนูู ุฌูุงุฒูู**:
   - ุงูุฌูุงุฒ 1: ุงููุณุชุฎุฏู A (ูุซูุงู Ahmed@bdcbiz.com)
   - ุงูุฌูุงุฒ 2: ุงููุณุชุฎุฏู B (ูุณุชุฎุฏู ุขุฎุฑ ูู ููุณ ุงูุดุฑูุฉ)

2. **ุจุฏุก ูุญุงุฏุซุฉ**:
   - ูู ุงูุฌูุงุฒ 1: ุงูุชุญ ุงูุดุงุช โ ุงุฎุชุฑ ุงููุณุชุฎุฏู B
   - ุฃุฑุณู ุฑุณุงูุฉ: "ุงูุณูุงู ุนูููู"

3. **ุงูุชุญูู ูู ุงููุฑุณู (ุงูุฌูุงุฒ 1)**:
   - โ ูุฌุจ ุฃู ุชุธูุฑ ุงูุฑุณุงูุฉ ููุฑุงู
   - โ ูุฌุจ ุฃู ุชููู ูู ุงูุฌุงูุจ ุงูุฃููู (isSentByMe = true)

4. **ุงูุชุญูู ูู ุงููุณุชูุจู (ุงูุฌูุงุฒ 2)**:
   - ุงูุชุธุฑ 3 ุซูุงูู (ุฃู ุงุถุบุท Refresh)
   - โ ูุฌุจ ุฃู ุชุธูุฑ ุงูุฑุณุงูุฉ
   - โ ูุฌุจ ุฃู ุชููู ูู ุงูุฌุงูุจ ุงูุฃูุณุฑ (isSentByMe = false)

5. **ุงูุฑุฏ ูู ุงูุฌูุงุฒ 2**:
   - ุฃุฑุณู ุฑุณุงูุฉ: "ูุนูููู ุงูุณูุงู"
   - โ ูุฌุจ ุฃู ุชุธูุฑ ููุฑุงู ุนูู ุงูุฌูุงุฒ 2
   - ุงูุชุธุฑ 3 ุซูุงูู ุนูู ุงูุฌูุงุฒ 1
   - โ ูุฌุจ ุฃู ุชุธูุฑ ุนูู ุงูุฌูุงุฒ 1

6. **ุชุจุงุฏู ุนุฏุฉ ุฑุณุงุฆู**:
   - ุฃุฑุณู 5-10 ุฑุณุงุฆู ูุชุชุงููุฉ ูู ูู ุฌูุงุฒ
   - โ ูุฌุจ ุฃู ุชุธูุฑ ุฌููุน ุงูุฑุณุงุฆู ุนูู ุงูุฌูุงุฒูู ุจุงูุชุฑุชูุจ ุงูุตุญูุญ

### ุงุฎุชุจุงุฑ ุงูุณููุงุฑูููุงุช:

#### ุณููุงุฑูู 1: ุฅุฑุณุงู ุฑุณุงุฆู ูุชุชุงููุฉ
```
ุงูุฌูุงุฒ 1 โ "ุฑุณุงูุฉ 1"
ุงูุฌูุงุฒ 1 โ "ุฑุณุงูุฉ 2"
ุงูุฌูุงุฒ 1 โ "ุฑุณุงูุฉ 3"

ุงูุชููุน: ุฌููุน ุงูุฑุณุงุฆู ุชุธูุฑ ุนูู ุงูุฌูุงุฒูู โ
```

#### ุณููุงุฑูู 2: ุฅุฑุณุงู ูุชุฒุงูู
```
ุงูุฌูุงุฒ 1 โ "ูู ุงูุฌูุงุฒ 1" (ููุณ ุงูููุช)
ุงูุฌูุงุฒ 2 โ "ูู ุงูุฌูุงุฒ 2"

ุงูุชููุน: ููุง ุงูุฑุณุงูุชูู ุชุธูุฑ ุนูู ุงูุฌูุงุฒูู โ
```

#### ุณููุงุฑูู 3: ุฅุฑุณุงู ูุน ูุฑููุงุช
```
ุงูุฌูุงุฒ 1 โ ๐ท ุตูุฑุฉ
ุงูุฌูุงุฒ 2 โ "ุชู ุงุณุชูุงู ุงูุตูุฑุฉ"

ุงูุชููุน: ุงูุตูุฑุฉ ูุงูุฑุฏ ูุธูุฑุงู ุนูู ุงูุฌูุงุฒูู โ
```

## ๐ ุชุญููู ุงูุฃุฏุงุก

### ูุจู ุงูุฅุตูุงุญ:
- ุฒูู ุธููุฑ ุงูุฑุณุงูุฉ ูููุฑุณู: ููุฑู
- ุฒูู ุธููุฑ ุงูุฑุณุงูุฉ ูููุณุชูุจู: 3 ุซูุงูู (Polling) ุฃู ูุง ุชุธูุฑ โ
- ุนุฏุฏ API Calls ุนูุฏ ุงูุฅุฑุณุงู: 1 (sendMessage)

### ุจุนุฏ ุงูุฅุตูุงุญ:
- ุฒูู ุธููุฑ ุงูุฑุณุงูุฉ ูููุฑุณู: ููุฑู
- ุฒูู ุธููุฑ ุงูุฑุณุงูุฉ ูููุณุชูุจู: 3 ุซูุงูู (Polling) โ
- ุนุฏุฏ API Calls ุนูุฏ ุงูุฅุฑุณุงู: 2 (sendMessage + refreshMessages)

**ููุงุญุธุฉ**: ุฒูุงุฏุฉ API call ูุงุญุฏ ููุจููุฉ ูุถูุงู ูุฒุงููุฉ ุงูุฑุณุงุฆู ุจุดูู ุตุญูุญ.

## ๐ง ูููุงุช ุชู ุชุนุฏูููุง

1. **lib/features/chat/logic/cubit/messages_cubit.dart**
   - ุฅุถุงูุฉ `await refreshMessages()` ุจุนุฏ ุฅุฑุณุงู ุงูุฑุณุงูุฉ

## ๐ ุงูุจูุงุก ูุงููุดุฑ

ุชู ุจูุงุก ุงูุชุทุจูู ุจูุฌุงุญ:

```bash
flutter clean
flutter pub get
flutter build apk --release --obfuscate --split-debug-info=build/debug_info
```

**ุงููุชูุฌุฉ**:
- โ ุจูุงุก ูุงุฌุญ
- โ ุญุฌู ุงูู APK: 52.7MB
- โ ูููุน ุงูููู: `build/app/outputs/flutter-apk/app-release.apk`

## ๐ฑ ูุชุทูุจุงุช ุงูุงุฎุชุจุงุฑ

### ุงูุจูุฆุฉ:
- Flutter SDK: 3.9.2+
- Backend: Laravel (Production: https://erp1.bdcbiz.com)
- API Base URL: ูุถุจูุท ุนูู `baseUrlProduction`

### ุงูุญุณุงุจุงุช:
- ุงููุณุชุฎุฏู 1: Ahmed@bdcbiz.com (password: password)
- ุงููุณุชุฎุฏู 2: ุฃู ูุณุชุฎุฏู ุขุฎุฑ ูู ุดุฑูุฉ BDC

### ุงูุฃุฌูุฒุฉ:
- ุฌูุงุฒูู Android (ุฃู ุฌูุงุฒ + ูุญุงูู)
- ุงุชุตุงู ุฅูุชุฑูุช ูุณุชูุฑ

## โ๏ธ ููุงุญุธุงุช ูููุฉ

1. **Polling**:
   - ูุนูู ูู 3 ุซูุงูู ูู fallback
   - ูุถูู ุชุญุฏูุซ ุงูุฑุณุงุฆู ุญุชู ูู ูุดู WebSocket

2. **WebSocket**:
   - ูุง ูุฒุงู ูุนุทู ุฃู ุบูุฑ ูุชุฒุงูู ุจุดูู ูุงูู
   - ุงูุงุนุชูุงุฏ ุงูุฑุฆูุณู ุนูู Polling + Refresh ุจุนุฏ ุงูุฅุฑุณุงู

3. **ุงูุฃุฏุงุก**:
   - Refresh ููุฑู ุจุนุฏ ูู ุฅุฑุณุงู
   - ูุฏ ูุณุจุจ ุญูู ุฅุถุงูู ุนูู ุงูุณูุฑูุฑ ุนูุฏ ุงูุฅุฑุณุงู ุงููุชูุฑุฑ
   - ููุจูู ูุฃู ุงููุญุงุฏุซุงุช ุนุงุฏุฉ ููุณุช ุณุฑูุนุฉ ุฌุฏุงู

4. **ุงูุชุญุณููุงุช ุงููุณุชูุจููุฉ**:
   - ุชูุนูู WebSocket ุจุดูู ูุงูู ููุชุญุฏูุซ ุงูููุฑู
   - ุงุณุชุฎุฏุงู Server-Sent Events (SSE) ูุจุฏูู
   - ุชุญุณูู Polling ููููู ุฃูุซุฑ ุฐูุงุกู (ูุชููู ุนูุฏ ุนุฏู ุงููุดุงุท)

## โ ุงูุฎูุงุตุฉ

ุชู ุฅุตูุงุญ ูุดููุฉ ูุฒุงููุฉ ุงูุฑุณุงุฆู ุจูุฌุงุญ. ุงูุขู:
- โ ุงููุฑุณู ูุฑู ุฑุณุงุฆูู ููุฑุงู
- โ ุงููุณุชูุจู ูุฑู ุฌููุน ุงูุฑุณุงุฆู (ุจุนุฏ 3 ุซูุงูู ูุญุฏ ุฃูุตู)
- โ ุฌููุน ุงูุฑุณุงุฆู ูุชุฒุงููุฉ ุจูู ุงูุทุฑููู
- โ ุชุฑุชูุจ ุงูุฑุณุงุฆู ุตุญูุญ
- โ ูุง ุชูุฌุฏ ุฑุณุงุฆู ููููุฏุฉ

**ุงูุญู ุจุณูุท ููุนุงู**: refresh ููุฑู ุจุนุฏ ุงูุฅุฑุณุงู + polling ูุณุชูุฑ = ูุฒุงููุฉ ูุงููุฉ! โจ

---

**ุชุงุฑูุฎ ุงูุฅุตูุงุญ**: 2025-01-16
**ุงูุฅุตุฏุงุฑ**: 1.0.1
**ุงูุญุงูุฉ**: โ ุชู ุงูุงุฎุชุจุงุฑ ูุงููุดุฑ
