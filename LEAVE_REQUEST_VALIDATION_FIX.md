# โ Leave Request Validation - Advance Notice Fix

## ุงููุดููุฉ (Problem)

ุนูุฏ ุชูุฏูู ุทูุจ ุฅุฌุงุฒุฉุ ูุงู ุงูุทูุจ ููุฑุณู ุฅูู ุงูู Backend ุซู ููุฑูุถ ุจุณุจุจ ุนุฏู ููุงูุฉ ุงูุฅุดุนุงุฑ ุงููุณุจู:

```
Error [400]: Leave request validation failed
"This vacation type requires 14 days advance notice."
```

**ุงูุณููุงุฑูู**:
- ุงููุณุชุฎุฏู ูุฎุชุงุฑ "ุงูุฅุฌุงุฒุฉ ุงูุณูููุฉ" (vacation_type_id: 1)
- ูุฎุชุงุฑ ุชุงุฑูุฎ ุจุฏุก: 2025-11-12 (ุบุฏุงู)
- ุงูุชุงุฑูุฎ ุงูุญุงูู: 2025-11-11 (ุงูููู)
- ุงููุฑู: ููู ูุงุญุฏ ููุท โ
- ุงููุทููุจ: 14 ููู ุฅุดุนุงุฑ ูุณุจู โ

**ุงููุชูุฌุฉ**: ุงูุทูุจ ููุฑูุถ ูู ุงูู Backend

---

## ุงูุญู (Solution)

ุชู ุชุทุจูู **3 ูุณุชููุงุช ูู ุงูู Validation** ูู ุงูู Frontend ูููุน ุฅุฑุณุงู ุทูุจุงุช ุบูุฑ ุตุงูุญุฉ:

### 1๏ธโฃ ุนุฑุถ ูุชุทูุจุงุช ุงูุฅุดุนุงุฑ ุงููุณุจู

ุนูุฏ ุงุฎุชูุงุฑ ููุน ุงูุฅุฌุงุฒุฉุ ูุธูุฑ ุชูุจูู ูุงุถุญ ุจูุชุทูุจุงุช ุงูุฅุดุนุงุฑ:

```dart
// Show notice requirement after selecting vacation type
if (_selectedLeaveTypeId != null && selectedType.requiredDaysBefore > 0) {
  Container(
    decoration: BoxDecoration(
      color: AppColors.warning.withOpacity(0.1),
      borderRadius: BorderRadius.circular(8),
    ),
    child: Row(
      children: [
        Icon(Icons.schedule, color: AppColors.warning),
        Text('ูุชุทูุจ ุฅุดุนุงุฑ ูุณุจู: ${selectedType.requiredDaysBefore} ููู ูุจู ุชุงุฑูุฎ ุงูุจุฏุก'),
      ],
    ),
  );
}
```

**ุงููุชูุฌุฉ**:
```
โ๏ธ ูุชุทูุจ ุฅุดุนุงุฑ ูุณุจู: 14 ููู ูุจู ุชุงุฑูุฎ ุงูุจุฏุก
```

### 2๏ธโฃ ููุน ุงุฎุชูุงุฑ ุชูุงุฑูุฎ ุบูุฑ ุตุงูุญุฉ ูู Date Picker

ุชู ุชุนุฏูู `firstDate` ูู ุงูู Date Picker ููุจุฏุฃ ูู ุงูุชุงุฑูุฎ ุงููุณููุญ:

```dart
Future<void> _selectDate(BuildContext context, bool isStartDate) async {
  DateTime firstSelectableDate = DateTime.now();

  // If vacation type is selected, apply notice period
  if (_selectedLeaveTypeId != null && vacationTypes.isNotEmpty) {
    final selectedType = vacationTypes.firstWhere(
      (type) => type.id == _selectedLeaveTypeId,
    );

    // Add required notice days to current date
    if (selectedType.requiredDaysBefore > 0) {
      firstSelectableDate = DateTime.now().add(
        Duration(days: selectedType.requiredDaysBefore),
      );
    }
  }

  final DateTime? picked = await showDatePicker(
    context: context,
    firstDate: firstSelectableDate,  // โญ ูุง ูููู ุงุฎุชูุงุฑ ุชุงุฑูุฎ ูุจู ูุฐุง
    lastDate: DateTime.now().add(const Duration(days: 365)),
  );
}
```

**ุงููุชูุฌุฉ**:
- **ุงูููู**: 2025-11-11
- **ุงูุฅุฌุงุฒุฉ ุงูุณูููุฉ (14 ููู)**: ุฃูู ุชุงุฑูุฎ ูุชุงุญ = 2025-11-25
- **ุงูุฅุฌุงุฒุฉ ุงููุฑุถูุฉ (0 ููู)**: ุฃูู ุชุงุฑูุฎ ูุชุงุญ = 2025-11-11 (ุงูููู)

### 3๏ธโฃ Validation ูุจู ุงูุฅุฑุณุงู ููู Backend

ุชู ุฅุถุงูุฉ ูุญุต ููุงุฆู ูู `_handleSubmit()`:

```dart
void _handleSubmit() {
  // ... (ุจุงูู ุงูู validations)

  // Validate notice period
  final state = context.read<LeaveCubit>().state;
  if (state is VacationTypesLoaded) {
    final selectedType = state.availableTypes.firstWhere(
      (type) => type.id == _selectedLeaveTypeId,
    );

    final daysDifference = _startDate!.difference(DateTime.now()).inDays;

    if (daysDifference < selectedType.requiredDaysBefore) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text(
            'ูุฐุง ุงูููุน ูู ุงูุฅุฌุงุฒุฉ ูุชุทูุจ ุฅุดุนุงุฑุงู ูุณุจูุงู ${selectedType.requiredDaysBefore} ููู.\n'
            'ูุฑุฌู ุงุฎุชูุงุฑ ุชุงุฑูุฎ ุจุฏุก ุจุนุฏ ${selectedType.requiredDaysBefore} ููู ูู ุงูุขู ุนูู ุงูุฃูู.',
          ),
          backgroundColor: AppColors.error,
          duration: const Duration(seconds: 5),
        ),
      );
      return; // โญ ูุง ููุฑุณู ุงูุทูุจ
    }
  }

  // Submit to backend
  context.read<LeaveCubit>().applyLeave(...);
}
```

### 4๏ธโฃ ุฅุนุงุฏุฉ ุชุนููู ุงูุชูุงุฑูุฎ ุนูุฏ ุชุบููุฑ ููุน ุงูุฅุฌุงุฒุฉ

```dart
onChanged: (typeId) {
  setState(() {
    _selectedLeaveTypeId = typeId;
    // Reset dates when changing vacation type
    _startDate = null;
    _endDate = null;
  });
}
```

**ุงูุณุจุจ**: ุงูุชูุงุฑูุฎ ุงูููุฎุชุงุฑุฉ ูุฏ ูุง ุชููู ุตุงูุญุฉ ููููุน ุงูุฌุฏูุฏ.

---

## ๐ฏ ููู ูุนูู ุงููุธุงู (How It Works)

### ูุซุงู 1: ุงูุฅุฌุงุฒุฉ ุงูุณูููุฉ (14 ููู ุฅุดุนุงุฑ)

```
ุงูุชุงุฑูุฎ ุงูุญุงูู: 2025-11-11

1. ุงููุณุชุฎุฏู ูุฎุชุงุฑ "ุงูุฅุฌุงุฒุฉ ุงูุณูููุฉ"
2. ูุธูุฑ: "โ๏ธ ูุชุทูุจ ุฅุดุนุงุฑ ูุณุจู: 14 ููู ูุจู ุชุงุฑูุฎ ุงูุจุฏุก"
3. ููุชุญ Date Picker
4. ุฃูู ุชุงุฑูุฎ ูุชุงุญ: 2025-11-25 (11 + 14)
5. ูุง ูููู ุงุฎุชูุงุฑ 12, 13, 14, ... 24 ููููุจุฑ โ
6. ูุฎุชุงุฑ 2025-11-25 ุฃู ุจุนุฏู โ
7. validation ุชูุฑ ุจูุฌุงุญ
8. ุงูุทูุจ ููุฑุณู ููู Backend โ
```

### ูุซุงู 2: ุฅุฌุงุฒุฉ ุงูููุงุฉ (0 ููู ุฅุดุนุงุฑ - ููุฑูุฉ)

```
ุงูุชุงุฑูุฎ ุงูุญุงูู: 2025-11-11

1. ุงููุณุชุฎุฏู ูุฎุชุงุฑ "ุฅุฌุงุฒุฉ ุงูููุงุฉ"
2. ูุง ูุธูุฑ ุชูุจูู (requiredDaysBefore = 0)
3. ููุชุญ Date Picker
4. ุฃูู ุชุงุฑูุฎ ูุชุงุญ: 2025-11-11 (ุงูููู)
5. ูููู ุงุฎุชูุงุฑ ุงูููู ุฃู ุบุฏุงู โ
6. validation ุชูุฑ ุจูุฌุงุญ
7. ุงูุทูุจ ููุฑุณู ููู Backend โ
```

### ูุซุงู 3: ุฅุฌุงุฒุฉ ุงูุญุฌ (60 ููู ุฅุดุนุงุฑ)

```
ุงูุชุงุฑูุฎ ุงูุญุงูู: 2025-11-11

1. ุงููุณุชุฎุฏู ูุฎุชุงุฑ "ุฅุฌุงุฒุฉ ุงูุญุฌ"
2. ูุธูุฑ: "โ๏ธ ูุชุทูุจ ุฅุดุนุงุฑ ูุณุจู: 60 ููู ูุจู ุชุงุฑูุฎ ุงูุจุฏุก"
3. ููุชุญ Date Picker
4. ุฃูู ุชุงุฑูุฎ ูุชุงุญ: 2026-01-10 (11 + 60)
5. ูุง ูููู ุงุฎุชูุงุฑ ุฃู ุชุงุฑูุฎ ูุจู 10 ููุงูุฑ 2026 โ
6. validation ุชูุฑ ุจูุฌุงุญ
7. ุงูุทูุจ ููุฑุณู ููู Backend โ
```

---

## ๐ ุฌุฏูู ูุชุทูุจุงุช ุงูุฅุดุนุงุฑ (Notice Requirements)

| ููุน ุงูุฅุฌุงุฒุฉ | required_days_before | ุฃูู ุชุงุฑูุฎ ูุชุงุญ (ูู 11 ููููุจุฑ) |
|-------------|----------------------|--------------------------------|
| ุงูุฅุฌุงุฒุฉ ุงูุณูููุฉ | 14 | 25 ููููุจุฑ 2025 |
| ุงูุฅุฌุงุฒุฉ ุงููุฑุถูุฉ | 0 | 11 ููููุจุฑ 2025 (ุงูููู) |
| ุฅุฌุงุฒุฉ ุงููุถุน | 30 | 11 ุฏูุณูุจุฑ 2025 |
| ุฅุฌุงุฒุฉ ุงูุฒูุงุฌ | 7 | 18 ููููุจุฑ 2025 |
| ุฅุฌุงุฒุฉ ุงูููุงุฉ | 0 | 11 ููููุจุฑ 2025 (ุงูููู) |
| ุฅุฌุงุฒุฉ ุงูุญุฌ | 60 | 10 ููุงูุฑ 2026 |
| ุงูุฅุฌุงุฒุฉ ุงูุนุงุฑุถุฉ | 0 | 11 ููููุจุฑ 2025 (ุงูููู) |
| ุฅุฌุงุฒุฉ ุจุฏูู ุฃุฌุฑ | 14 | 25 ููููุจุฑ 2025 |
| ุฅุฌุงุฒุฉ ุงูุงูุชุญุงูุงุช | 14 | 25 ููููุจุฑ 2025 |
| ุฅุฌุงุฒุฉ ุฑุนุงูุฉ ุงูุทูู | 30 | 11 ุฏูุณูุจุฑ 2025 |

---

## ๐จ User Experience Flow

### ูุจู ุงูุชุญุณููุงุช:
```
1. ุงุฎุชูุงุฑ ููุน ุฅุฌุงุฒุฉ
2. ุงุฎุชูุงุฑ ุชุงุฑูุฎ ุจุฏุก (ุบุฏุงู)
3. ุงุฎุชูุงุฑ ุชุงุฑูุฎ ููุงูุฉ
4. ูุชุงุจุฉ ุงูุณุจุจ
5. ุฅุฑุณุงู ุงูุทูุจ โณ
6. โ Error: "This vacation type requires 14 days advance notice"
7. ุงููุณุชุฎุฏู ูุญุชุงุฑ: ููุงุฐุงุ
```

### ุจุนุฏ ุงูุชุญุณููุงุช:
```
1. ุงุฎุชูุงุฑ ููุน ุฅุฌุงุฒุฉ
2. โ ุชูุจูู ูุธูุฑ: "ูุชุทูุจ ุฅุดุนุงุฑ ูุณุจู: 14 ููู"
3. ูุชุญ Date Picker
4. โ ูุง ูููู ุงุฎุชูุงุฑ ุชูุงุฑูุฎ ูุจู 14 ููู
5. ุงุฎุชูุงุฑ ุชุงุฑูุฎ ุตุงูุญ (ุจุนุฏ 14 ููู)
6. ุงุฎุชูุงุฑ ุชุงุฑูุฎ ููุงูุฉ
7. ูุชุงุจุฉ ุงูุณุจุจ
8. ุฅุฑุณุงู ุงูุทูุจ โณ
9. โ Success: "Leave request submitted successfully"
```

---

## ๐ Edge Cases

### Case 1: ุชุบููุฑ ููุน ุงูุฅุฌุงุฒุฉ ุจุนุฏ ุงุฎุชูุงุฑ ุงูุชูุงุฑูุฎ

**ุงูุณููุงุฑูู**:
1. ุงุฎุชุงุฑ "ุฅุฌุงุฒุฉ ุงูููุงุฉ" (0 ููู)
2. ุงุฎุชุงุฑ ุชุงุฑูุฎ ุจุฏุก: ุบุฏุงู
3. ุบููุฑ ุฅูู "ุงูุฅุฌุงุฒุฉ ุงูุณูููุฉ" (14 ููู)

**ุงููุชูุฌุฉ ูุจู**:
- ุงูุชุงุฑูุฎ ุงูููุฎุชุงุฑ (ุบุฏุงู) ูุจูู โ
- ุนูุฏ ุงูุฅุฑุณุงู: validation error

**ุงููุชูุฌุฉ ุจุนุฏ**:
- ุงูุชูุงุฑูุฎ ุชูุนุงุฏ ุฅูู null โ
- ูุฌุจ ุงุฎุชูุงุฑ ุชูุงุฑูุฎ ุฌุฏูุฏุฉ
- ุงูุชูุงุฑูุฎ ุงูุฌุฏูุฏุฉ ุณุชููู ุตุงูุญุฉ

### Case 2: ุญุงูู ุชุนุฏูู ุงูุชุงุฑูุฎ manually

**ุงูุณููุงุฑูู**:
- ุงููุณุชุฎุฏู ูุญุงูู ุชุบููุฑ ุงูุชุงุฑูุฎ ุจุทุฑููุฉ ูุง (ูุซู debugging)

**ุงููุชูุฌุฉ**:
- ุงูู validation ูู `_handleSubmit()` ุณุชููุน ุงูุฅุฑุณุงู โ
- ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ ุจุงูุนุฑุจูุฉ

### Case 3: Backend ูุบูุฑ ุงููุชุทูุจุงุช

**ุงูุณููุงุฑูู**:
- ุงูู Backend ูุบูุฑ `required_days_before` ูู 14 ุฅูู 21

**ุงููุชูุฌุฉ**:
- Flutter ูุณุชุฏุนู API ููุญุตู ุนูู ุงููููุฉ ุงูุฌุฏูุฏุฉ (21)
- Date Picker ูุณุชุฎุฏู ุงููููุฉ ุงูุฌุฏูุฏุฉ ุชููุงุฆูุงู โ
- No code changes needed ูู Flutter

---

## โ ูุง ุชู ุฅุตูุงุญู (Summary)

| ุงููุดููุฉ | ุงูุญู | ุงูููู |
|---------|------|-------|
| ูุง ููุฌุฏ ุชูุจูู ุจูุชุทูุจุงุช ุงูุฅุดุนุงุฑ | ุนุฑุถ ุฑุณุงูุฉ ูุงุถุญุฉ ุจุนุฏ ุงุฎุชูุงุฑ ุงูููุน | `leaves_apply_widget.dart` |
| ูููู ุงุฎุชูุงุฑ ุชูุงุฑูุฎ ุบูุฑ ุตุงูุญุฉ | `firstDate` ูู Date Picker = ุงูููู + required_days | `leaves_apply_widget.dart` |
| ูุง ุชูุฌุฏ validation ูุจู ุงูุฅุฑุณุงู | ุฅุถุงูุฉ ูุญุต ูู `_handleSubmit()` | `leaves_apply_widget.dart` |
| ุชูุงุฑูุฎ ูุฏููุฉ ุจุนุฏ ุชุบููุฑ ุงูููุน | ุฅุนุงุฏุฉ ุชุนููู ุงูุชูุงุฑูุฎ ุนูุฏ ุชุบููุฑ ุงูููุน | `leaves_apply_widget.dart` |
| ุฑุณุงุฆู ุจุงูุฅูุฌููุฒูุฉ | ุชุฑุฌูุฉ ุฌููุน ุฑุณุงุฆู ุงูู validation | `leaves_apply_widget.dart` |

---

## ๐งช ุณููุงุฑูููุงุช ุงูุงุฎุชุจุงุฑ (Test Scenarios)

### โ Test 1: ุฅุฌุงุฒุฉ ุณูููุฉ (14 ููู)

1. ุงูุชุญ Apply Leave
2. ุงุฎุชุฑ "ุงูุฅุฌุงุฒุฉ ุงูุณูููุฉ"
3. ุชุญูู: ูุธูุฑ "ูุชุทูุจ ุฅุดุนุงุฑ ูุณุจู: 14 ููู"
4. ุงุถุบุท ุนูู "Start Date"
5. ุชุญูู: ุฃูู ุชุงุฑูุฎ ูุชุงุญ = ุงูููู + 14 ููู
6. ุงุฎุชุฑ ุชุงุฑูุฎ ุตุงูุญ
7. ุงุฎุชุฑ End Date
8. ุฃุฏุฎู ุณุจุจ
9. ุฅุฑุณุงู
10. **ูุชููุน**: โ Success

### โ Test 2: ุฅุฌุงุฒุฉ ููุงุฉ (0 ููู - ููุฑูุฉ)

1. ุงูุชุญ Apply Leave
2. ุงุฎุชุฑ "ุฅุฌุงุฒุฉ ุงูููุงุฉ"
3. ุชุญูู: ูุง ูุธูุฑ ุชูุจูู ุฅุดุนุงุฑ
4. ุงุถุบุท ุนูู "Start Date"
5. ุชุญูู: ุฃูู ุชุงุฑูุฎ ูุชุงุญ = ุงูููู
6. ุงุฎุชุฑ ุงูููู
7. ุงุฎุชุฑ End Date
8. ุฃุฏุฎู ุณุจุจ
9. ุฅุฑุณุงู
10. **ูุชููุน**: โ Success

### โ Test 3: ุชุบููุฑ ููุน ุงูุฅุฌุงุฒุฉ

1. ุงูุชุญ Apply Leave
2. ุงุฎุชุฑ "ุฅุฌุงุฒุฉ ุงูููุงุฉ"
3. ุงุฎุชุฑ ุชุงุฑูุฎ ุจุฏุก: ุงูููู
4. ุบููุฑ ุฅูู "ุงูุฅุฌุงุฒุฉ ุงูุณูููุฉ"
5. ุชุญูู: ุงูุชูุงุฑูุฎ ุฃุตุจุญุช ูุงุฑุบุฉ
6. ุงุฎุชุฑ ุชูุงุฑูุฎ ุฌุฏูุฏุฉ ุตุงูุญุฉ
7. ุฅุฑุณุงู
8. **ูุชููุน**: โ Success

### โ Test 4: ูุญุงููุฉ ุงุฎุชูุงุฑ ุชุงุฑูุฎ ุบูุฑ ุตุงูุญ

1. ุงูุชุญ Apply Leave
2. ุงุฎุชุฑ "ุฅุฌุงุฒุฉ ุงูุญุฌ" (60 ููู)
3. ุงุถุบุท ุนูู "Start Date"
4. ุญุงูู ุงุฎุชูุงุฑ ุชุงุฑูุฎ ูุจู 60 ููู
5. **ูุชููุน**: ุงูุชุงุฑูุฎ ุบูุฑ ูุงุจู ููููุฑ (disabled)

---

## ๐ ุงููููุงุช ุงููุนุฏููุฉ (Modified Files)

### Flutter
1. โ `lib/features/leaves/ui/widgets/leaves_apply_widget.dart`
   - ุนุฑุถ ูุชุทูุจุงุช ุงูุฅุดุนุงุฑ ุงููุณุจู
   - ุชุนุฏูู Date Picker `firstDate`
   - ุฅุถุงูุฉ validation ูู `_handleSubmit()`
   - ุฅุนุงุฏุฉ ุชุนููู ุงูุชูุงุฑูุฎ ุนูุฏ ุชุบููุฑ ุงูููุน
   - ุชุฑุฌูุฉ ุฑุณุงุฆู ุงูุฎุทุฃ ููุนุฑุจูุฉ

### Backend
- โ ูุง ุชูุฌุฏ ุชุบููุฑุงุช (ุงูู validation ููุฌูุฏ ุจุงููุนู)

---

## ๐ฏ Benefits

### ูููุณุชุฎุฏู:
1. โ ูุนุฑู ูุชุทูุจุงุช ุงูุฅุดุนุงุฑ ูุจู ุงุฎุชูุงุฑ ุงูุชุงุฑูุฎ
2. โ ูุง ููููู ุงุฎุชูุงุฑ ุชูุงุฑูุฎ ุฎุงุทุฆุฉ
3. โ ุฑุณุงุฆู ุฎุทุฃ ูุงุถุญุฉ ุจุงูุนุฑุจูุฉ
4. โ ุชุฌุฑุจุฉ ูุณุชุฎุฏู ุฃูุถู (UX)

### ูููุธุงู:
1. โ ุชูููู ุทูุจุงุช ุงูู API ุงููุงุดูุฉ
2. โ ุชูููู ุงูุญูู ุนูู ุงูู Backend
3. โ ุจูุงูุงุช ุฃูุธู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
4. โ ุฃูู errors ูู ุงูู logs

---

## ๐ References

- **Error Handling**: `LEAVE_TYPES_ERROR_HANDLING.md`
- **Vacation Types**: `VACATION_TYPES_EGYPTIAN_LAW.md`
- **Integration**: `VACATION_TYPES_FLUTTER_INTEGRATION.md`

---

**ุชุงุฑูุฎ ุงูุชุญุฏูุซ**: 11 ููููุจุฑ 2025
**ุงูุญุงูุฉ**: โ ุฌุงูุฒ ููุงุณุชุฎุฏุงู
**ุงููุทูุฑ**: Claude Code
**ุงูุฅุตุฏุงุฑ**: 1.2
